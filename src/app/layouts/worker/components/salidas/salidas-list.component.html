<div class="salidas-container">
  <mat-card class="salidas-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>exit_to_app</mat-icon> Gestión de Salidas
      </mat-card-title>
      <mat-card-subtitle>Seleccione un salón y un alumno para ver salidas</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="salidaForm" class="salidas-form">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Salón</mat-label>
          <mat-select formControlName="idSalon" (selectionChange)="onSalonChange()">
            <mat-option *ngIf="!salones.length && !loading" disabled>
              No hay salones disponibles
            </mat-option>
            <mat-option *ngFor="let salon of salones" [value]="salon.id">
              {{ salon.nombre }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>class</mat-icon>
          <mat-error *ngIf="salidaForm.get('idSalon')?.hasError('required')">
            El salón es requerido
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Alumno</mat-label>
          <mat-select formControlName="idAlumno" (selectionChange)="onAlumnoChange()">
            <mat-option *ngIf="!alumnos.length && !loading" disabled>
              No hay alumnos disponibles
            </mat-option>
            <mat-option *ngFor="let alumno of alumnos" [value]="alumno.id">
              {{ alumno.nombre_completo }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>person</mat-icon>
          <mat-error *ngIf="salidaForm.get('idAlumno')?.hasError('required')">
            El alumno es requerido
          </mat-error>
        </mat-form-field>
      </form>



      <!-- Tabla de salidas -->
      <div *ngIf="salidas.length > 0" class="salidas-table-container">
        <table mat-table [dataSource]="salidas" class="mat-elevation-z2 full-width-table">

          <!-- Fecha -->
          <ng-container matColumnDef="fecha">
            <th mat-header-cell *matHeaderCellDef> Fecha </th>
            <td mat-cell *matCellDef="let salida"> 
              {{ salida.fecha || salida.fecha_salida || 'N/A' }} 
            </td>
          </ng-container>

          <!-- Hora -->
          <ng-container matColumnDef="hora">
            <th mat-header-cell *matHeaderCellDef> Hora </th>
            <td mat-cell *matCellDef="let salida"> 
              {{ salida.hora || salida.hora_salida || 'N/A' }} 
            </td>
          </ng-container>

          <!-- Estado -->
          <ng-container matColumnDef="estado">
            <th mat-header-cell *matHeaderCellDef> Estado </th>
            <td mat-cell *matCellDef="let salida">
              <mat-icon [ngClass]="{
                  'estado-puntual': salida.estado?.toLowerCase() === 'puntual',
                  'estado-tarde': salida.estado?.toLowerCase() === 'tarde'
                }">
                {{
                salida.estado?.toLowerCase() === 'puntual'
                ? 'check_circle'
                : salida.estado?.toLowerCase() === 'tarde'
                ? 'schedule'
                : 'help_outline'
                }}
              </mat-icon>
              {{ salida.estado || 'Sin estado' }}
            </td>
          </ng-container>

          <!-- Persona Autorizada -->
          <ng-container matColumnDef="persona">
            <th mat-header-cell *matHeaderCellDef> Persona Autorizada </th>
            <td mat-cell *matCellDef="let salida"> 
              {{ salida.persona_autorizada || 'No especificada' }} 
            </td>
          </ng-container>

          <!-- Columna de Acciones -->
          <ng-container matColumnDef="acciones">
            <th mat-header-cell *matHeaderCellDef> Acciones </th>
            <td mat-cell *matCellDef="let salida; let i = index">
              <button 
                mat-icon-button 
                color="warn" 
                (click)="eliminarSalida(i)"
                matTooltip="Eliminar salida"
                [disabled]="loading">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>

          <!-- Definir las columnas que se mostrarán -->
          <tr mat-header-row *matHeaderRowDef="['fecha', 'hora', 'estado', 'persona', 'acciones']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['fecha', 'hora', 'estado', 'persona', 'acciones']"></tr>
        </table>
      </div>

      <!-- Cargando -->
      <div *ngIf="loading" class="loading">
        <mat-spinner diameter="24"></mat-spinner> 
        Cargando datos...
      </div>

      <!-- Error -->
      <div *ngIf="error" class="error">
        <mat-icon>error_outline</mat-icon> {{ error }}
      </div>

      <!-- Mensaje de éxito -->
      <div *ngIf="successMessage" class="success">
        <mat-icon>check_circle</mat-icon> {{ successMessage }}
      </div>
    </mat-card-content>
  </mat-card>
</div>