<div class="student-container">
  <div class="toolbar">
    <!-- Campo de búsqueda -->
    <mat-form-field appearance="outline" class="search-field">
      <input
        matInput
        placeholder="Buscar por nombre o DNI"
        [formControl]="searchTermControl"
      />
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <!-- Filtro por salón -->
    <!-- Filtro por salón -->
    <mat-form-field appearance="outline" class="salon-filter">
      <mat-label>Filtrar por Salón</mat-label>
      <mat-select
        [formControl]="salonFilterControl"
        (selectionChange)="onSalonFilterChange()"
      >
        <mat-option [value]="null">Todos los salones</mat-option>
        <mat-option *ngFor="let salon of availableSalones" [value]="salon.id">
          {{ salon.grado }} {{ salon.seccion }}
        </mat-option>
      </mat-select>
      <mat-icon matSuffix>class</mat-icon>
    </mat-form-field>

    <!-- Botón agregar -->
    <button
      mat-raised-button
      color="primary"
      class="add-button"
      [disabled]="loading"
      (click)="openAddDialog()"
    >
      <mat-icon>add</mat-icon>
      Agregar Alumno
    </button>
  </div>

  <!-- Información de filtros activos -->
  <div class="filter-info" *ngIf="selectedSalonId">
    <mat-icon>info</mat-icon>
    <span>Mostrando estudiantes del {{ getSelectedSalonName() }}</span>
    <button
      mat-icon-button
      (click)="salonFilterControl.setValue(''); onSalonFilterChange()"
      title="Limpiar filtro"
    >
      <mat-icon>clear</mat-icon>
    </button>
  </div>

  <div class="student-table">
    <div class="table-header">
      <span data-label="DNI">DNI</span>
      <span data-label="NOMBRE">NOMBRE</span>
      <span data-label="APODERADO">APODERADO</span>
      <span data-label="CÓDIGO">CÓDIGO</span>
      <span data-label="TELÉFONO">TELÉFONO</span>
      <span data-label="GRADO">GRADO</span>
      <span data-label="ACCIONES">ACCIONES</span>
    </div>

    <div class="table-body">
      <!-- Loading -->
      <div *ngIf="loading" class="loading-container">
        <div class="loading">
          Cargando datos
          <span class="spinner"></span>
        </div>
      </div>

      <!-- Loading salones -->
      <div *ngIf="loadingSalones" class="loading-container">
        <div class="loading">
          Cargando salones
          <span class="spinner"></span>
        </div>
      </div>

      <!-- Filas de estudiantes -->
      <div
        class="student-row"
        *ngFor="let student of filteredStudents; trackBy: trackByStudentId"
      >
        <span data-label="DNI">{{ student.numero_documento }}</span>
        <span data-label="NOMBRE">{{ student.nombre_completo }}</span>
        <span data-label="APODERADO" class="apoderado-cell">
          <div class="apoderado-info">
            <mat-icon class="parent-icon" [title]="student.parentesco">
              {{ getParentIcon(student.parentesco) }}
            </mat-icon>
            <span class="apoderado-name">
              {{ student.nombreApoderado }}
              {{ student.apellidoPaternoApoderado }}
              {{ student.apellidoMaternoApoderado }}
            </span>
            <mat-icon
              class="phone-icon"
              *ngIf="student.telefonoApoderado"
              [title]="'Teléfono: ' + student.telefonoApoderado"
            >
              phone
            </mat-icon>
          </div>
        </span>
        <span data-label="CÓDIGO">{{ student.codigo }}</span>
        <span data-label="TELÉFONO">{{ student.telefono || "N/A" }}</span>
        <span data-label="GRADO"
          >{{ student.grado }} - {{ student.salon }}</span
        >
        <span class="actions" data-label="ACCIONES">
          <button
            mat-icon-button
            (click)="openEditDialog(student)"
            class="edit-button"
            title="Editar estudiante"
            [disabled]="loading"
          >
            <mat-icon>edit</mat-icon>
          </button>
          <button
            mat-icon-button
            (click)="confirmDelete(student.id)"
            class="delete-button"
            title="Eliminar estudiante"
            [disabled]="loading"
          >
            <mat-icon>delete</mat-icon>
          </button>
        </span>
      </div>

      <!-- Mensaje cuando no hay datos -->
      <div
        *ngIf="filteredStudents.length === 0 && !loading && !loadingSalones"
        class="no-data-container"
      >
        <div class="no-data-message">
          <mat-icon>school</mat-icon>
          <p
            *ngIf="
              searchTermControl.value && searchTermControl.value.trim() !== ''
            "
          >
            No se encontraron estudiantes que coincidan con "<strong>{{
              searchTermControl.value
            }}</strong
            >"
          </p>
          <p
            *ngIf="
              selectedSalonId &&
              (!searchTermControl.value ||
                searchTermControl.value.trim() === '')
            "
          >
            No hay estudiantes en {{ getSelectedSalonName() }}
          </p>
          <p
            *ngIf="
              !selectedSalonId &&
              (!searchTermControl.value ||
                searchTermControl.value.trim() === '')
            "
          >
            No hay estudiantes registrados
          </p>
          <button
            mat-stroked-button
            color="primary"
            (click)="openAddDialog()"
            class="add-first-student"
          >
            <mat-icon>add</mat-icon>
            Agregar primer estudiante
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- PAGINACIÓN RESPONSIVA MEJORADA -->
  <div class="pagination" *ngIf="totalPages > 1 && !selectedSalonId">
    <div class="pagination-info">
      <span class="total-info">Total de alumnos: {{ totalAlumnos }}</span>
      <span class="page-info"
        >Página {{ currentPage }} de {{ totalPages }}</span
      >
      <span
        *ngIf="
          searchTermControl.value &&
          searchTermControl.value.trim() !== '' &&
          filteredStudents.length < students.length
        "
        class="filter-info"
      >
        ({{ filteredStudents.length }} coincidencias)
      </span>
    </div>

    <div class="pagination-controls">
      <!-- Botones de navegación para móvil -->
      <div *ngIf="isMobile" class="mobile-pagination">
        <button
          mat-icon-button
          class="nav-button"
          [disabled]="!canGoToPreviousPage() || loading"
          (click)="goToPreviousPage()"
          title="Página anterior"
        >
          <mat-icon>chevron_left</mat-icon>
        </button>

        <span class="current-page">{{ currentPage }}/{{ totalPages }}</span>

        <button
          mat-icon-button
          class="nav-button"
          [disabled]="!canGoToNextPage() || loading"
          (click)="goToNextPage()"
          title="Página siguiente"
        >
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>

      <!-- Paginación completa para desktop -->
      <div *ngIf="!isMobile" class="desktop-pagination">
        <!-- Botón primera página -->
        <button
          mat-icon-button
          class="nav-button"
          [disabled]="!canGoToFirstPage() || loading"
          (click)="goToFirstPage()"
          title="Primera página"
        >
          <mat-icon>first_page</mat-icon>
        </button>

        <!-- Botón página anterior -->
        <button
          mat-icon-button
          class="nav-button"
          [disabled]="!canGoToPreviousPage() || loading"
          (click)="goToPreviousPage()"
          title="Página anterior"
        >
          <mat-icon>chevron_left</mat-icon>
        </button>

        <!-- Puntos suspensivos antes -->
        <span *ngIf="showEllipsisBefore()" class="ellipsis">...</span>

        <!-- Números de página visibles -->
        <button
          *ngFor="let page of getPageNumbers()"
          mat-button
          [class.active]="page === currentPage"
          [disabled]="loading"
          (click)="changePage(page)"
          class="page-button"
          [title]="'Ir a página ' + page"
        >
          {{ page }}
        </button>

        <!-- Puntos suspensivos después -->
        <span *ngIf="showEllipsisAfter()" class="ellipsis">...</span>

        <!-- Botón página siguiente -->
        <button
          mat-icon-button
          class="nav-button"
          [disabled]="!canGoToNextPage() || loading"
          (click)="goToNextPage()"
          title="Página siguiente"
        >
          <mat-icon>chevron_right</mat-icon>
        </button>

        <!-- Botón última página -->
        <button
          mat-icon-button
          class="nav-button"
          [disabled]="!canGoToLastPage() || loading"
          (click)="goToLastPage()"
          title="Última página"
        >
          <mat-icon>last_page</mat-icon>
        </button>
      </div>
    </div>

    <!-- Paginación simple para móvil con números -->
    <div *ngIf="isMobile && totalPages <= 10" class="mobile-page-numbers">
      <button
        *ngFor="let page of getPageNumbers()"
        mat-button
        [class.active]="page === currentPage"
        [disabled]="loading"
        (click)="changePage(page)"
        class="page-button"
      >
        {{ page }}
      </button>
    </div>
  </div>

  <!-- Información cuando se filtra por salón -->
  <div class="salon-filter-info" *ngIf="selectedSalonId">
    <div class="filter-summary">
      <mat-icon>info</mat-icon>
      <span
        >Mostrando {{ filteredStudents.length }} estudiantes del
        {{ getSelectedSalonName() }}</span
      >
      <span
        *ngIf="searchTermControl.value && searchTermControl.value.trim() !== ''"
        class="search-summary"
      >
        ({{ filteredStudents.length }} coinciden con "{{
          searchTermControl.value
        }}")
      </span>
    </div>
    <p class="filter-note">
      <mat-icon>lightbulb</mat-icon>
      La paginación está deshabilitada cuando se filtra por salón específico.
    </p>
  </div>
</div>
