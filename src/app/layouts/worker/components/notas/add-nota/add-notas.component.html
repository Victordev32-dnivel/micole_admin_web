<div class="formal-dialog-container">
  <!-- Encabezado se mantiene igual -->
  <div class="dialog-header">
    <div class="header-content">
      <mat-icon class="header-icon">assignment_add</mat-icon>
      <div class="header-text">
        <h2 mat-dialog-title class="dialog-title">
          Registro de Notas Académicas
        </h2>
        <p class="dialog-subtitle">Sistema de Gestión de Evaluaciones</p>
      </div>
    </div>
  </div>

  <mat-dialog-content class="dialog-content">
    <form [formGroup]="noteForm" class="formal-form">
      <!-- Sección de datos académicos - REORGANIZADA -->
      <div class="form-section academic-section">
        <div class="section-header">
          <mat-icon class="section-icon">school</mat-icon>
          <h3 class="section-title">Datos Académicos</h3>
        </div>

        <!-- Campo de salón ahora arriba solo -->
        <div class="form-field">
          <mat-form-field appearance="outline" class="formal-field">
            <mat-label>Salón Académico *</mat-label>
            <mat-select
              formControlName="idSalon"
              (selectionChange)="onSalonChange()"
              required
            >
              <mat-option *ngFor="let salon of salones" [value]="salon.id">
                {{ salon.nombre }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>meeting_room</mat-icon>
            <mat-error *ngIf="noteForm.get('idSalon')?.hasError('required')">
              Selección de salón es requerida
            </mat-error>
          </mat-form-field>

          <div *ngIf="loadingSalones" class="loading-indicator">
            <mat-progress-spinner
              diameter="20"
              mode="indeterminate"
              color="primary"
            ></mat-progress-spinner>
            <span class="loading-text">Cargando salones...</span>
          </div>
        </div>

        <!-- Campo de alumno ahora debajo -->
        <div class="form-field">
          <mat-form-field appearance="outline" class="formal-field">
            <mat-label>Estudiante *</mat-label>
            <mat-select
              formControlName="idAlumno"
              [disabled]="!noteForm.get('idSalon')?.value || loadingAlumnos"
              required
            >
              <mat-option *ngFor="let alumno of alumnos" [value]="alumno.id">
                {{ alumno.nombre }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>person</mat-icon>
            <mat-error *ngIf="noteForm.get('idAlumno')?.hasError('required')">
              Selección de estudiante es requerida
            </mat-error>
          </mat-form-field>

          <div *ngIf="loadingAlumnos" class="loading-indicator">
            <mat-progress-spinner
              diameter="20"
              mode="indeterminate"
              color="primary"
            ></mat-progress-spinner>
            <span class="loading-text">Cargando estudiantes...</span>
          </div>

          <div
            *ngIf="noteForm.get('idSalon')?.value && alumnos.length === 0 && !loadingAlumnos"
            class="empty-state"
          >
            <mat-icon>group_off</mat-icon>
            <span>No hay estudiantes matriculados en este salón</span>
          </div>
        </div>
      </div>

      <!-- Sección de detalles de la nota -->
      <div class="form-section details-section">
        <div class="section-header">
          <mat-icon class="section-icon">description</mat-icon>
          <h3 class="section-title">Detalles de la Evaluación</h3>
        </div>

        <mat-form-field appearance="outline" class="formal-field">
          <mat-label>Descripción de la Evaluación *</mat-label>
          <textarea
            matInput
            formControlName="nombre"
            placeholder="Ej: Examen parcial de Matemáticas - Primer Trimestre 2023"
            rows="2"
            required
          ></textarea>
          <mat-icon matSuffix>notes</mat-icon>
          <mat-error *ngIf="noteForm.get('nombre')?.hasError('required')">
            La descripción es obligatoria
          </mat-error>
        </mat-form-field>
      </div>

      <!-- Sección de documento -->
      <div class="form-section document-section">
        <div class="section-header">
          <mat-icon class="section-icon">picture_as_pdf</mat-icon>
          <h3 class="section-title">Documento de Evaluación</h3>
        </div>

        <div class="document-upload">
          <input
            #fileInput
            type="file"
            (change)="onPdfUpload($event)"
            class="file-input"
            accept="application/pdf"
            hidden
          />

          <div
            class="upload-card"
            [class.active]="pdfFile"
            [class.disabled]="!noteForm.get('idAlumno')?.value || uploading"
          >
            <div *ngIf="!pdfFile" class="upload-instructions">
              <mat-icon class="upload-icon">cloud_upload</mat-icon>
              <h4>Subir Documento de Evaluación</h4>
              <p>Formato requerido: PDF (Tamaño máximo: 10MB)</p>

              <button
                mat-stroked-button
                color="primary"
                (click)="triggerFileInput()"
                [disabled]="!noteForm.get('idAlumno')?.value || uploading"
                type="button"
                class="select-button"
              >
                <mat-icon>attach_file</mat-icon>
                Seleccionar Archivo
              </button>
            </div>

            <div *ngIf="pdfFile" class="document-preview">
              <div class="document-info">
                <div class="document-icon">
                  <mat-icon>picture_as_pdf</mat-icon>
                </div>
                <div class="document-details">
                  <span class="document-name">{{ pdfName }}</span>
                  <span class="document-size"
                    >{{ (pdfFile.size / 1024 / 1024).toFixed(2) }} MB</span
                  >
                </div>
                <button
                  mat-icon-button
                  (click)="removePdf()"
                  [disabled]="uploading"
                  type="button"
                  class="remove-document"
                  matTooltip="Eliminar documento"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </div>

              <div
                *ngIf="uploadProgress > 0 && uploadProgress < 100"
                class="upload-status"
              >
                <mat-progress-bar
                  mode="determinate"
                  [value]="uploadProgress"
                ></mat-progress-bar>
                <div class="progress-details">
                  <span>Progreso de carga:</span>
                  <span class="progress-percent">{{ uploadProgress }}%</span>
                </div>
              </div>

              <div *ngIf="uploadProgress === 100" class="upload-complete">
                <mat-icon class="success-icon">check_circle</mat-icon>
                <span>Documento listo para registrar</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Notas importantes -->
      <div class="important-notes">
        <mat-icon>info</mat-icon>
        <div class="notes-content">
          <h4>Instrucciones importantes:</h4>
          <ul>
            <li>
              Todos los campos marcados con asterisco (*) son obligatorios
            </li>
            <li>
              Verifique que los datos del estudiante sean correctos antes de
              continuar
            </li>
            <li>
              El documento debe contener las evaluaciones con criterios claros
            </li>
            <li>El sistema generará un comprobante digital del registro</li>
          </ul>
        </div>
      </div>
    </form>
  </mat-dialog-content>

  <!-- Mensajes del sistema -->
  <div *ngIf="error" class="system-message error">
    <mat-icon>error</mat-icon>
    <div class="message-content">
      <strong>Error en el sistema:</strong>
      <p>{{ error }}</p>
    </div>
  </div>

  <!-- Acciones -->
  <mat-dialog-actions class="dialog-actions">
    <button mat-button (click)="onCancel()" type="button" class="cancel-action">
      <mat-icon>cancel</mat-icon>
      Cancelar
    </button>

    <button
      mat-raised-button
      color="primary"
      (click)="onSave()"
      [disabled]="
        !noteForm.valid ||
        !pdfFile ||
        uploading ||
        loadingSalones ||
        loadingAlumnos
      "
      type="button"
      class="save-action"
    >
      <mat-spinner
        *ngIf="uploading"
        diameter="20"
        class="action-spinner"
      ></mat-spinner>
      <mat-icon *ngIf="!uploading">save</mat-icon>
      <span>{{
        uploading ? "Procesando registro..." : "Registrar Evaluación"
      }}</span>
    </button>
  </mat-dialog-actions>
</div>
